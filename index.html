<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yujeong Calendar</title>
    <style>
        /* ê¹”ë” ê·¸ ìì²´! ìŠ¤í¬ë¡¤ë°”ë„ ì—†ê³  ì—¬ë°±ë„ ì—†ìŒ */
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; background: transparent; }
        
        /* ìº˜ë¦°ë” ì»¨í…Œì´ë„ˆ */
        .container { width: 100%; max-width: 320px; background: white; border-radius: 16px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        .header { font-size: 1.1rem; font-weight: 800; color: #333; text-align: center; margin-bottom: 15px; }
        
        .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-name { text-align: center; color: #aaa; font-size: 0.7rem; font-weight: 600; margin-bottom: 5px; }
        
        .day { 
            aspect-ratio: 1/1; border-radius: 8px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .day:hover { background-color: #f9f9f9; }
        .day.selected { border-color: #333; }
        
        /* ì˜¤ëŠ˜ */
        .day.today { color: #E16259; font-weight: bold; }
        
        /* ë°ì´í„° ìˆìŒ (í•‘í¬) */
        .day.has-event { background-color: #FFD9E8; color: white; font-weight: bold; }
        .day.has-event .dot { background-color: white; }
        
        .dot-box { display: flex; gap: 2px; margin-top: 3px; }
        .dot { width: 4px; height: 4px; background-color: #E16259; border-radius: 50%; }

        /* í•˜ë‹¨ ë¦¬ìŠ¤íŠ¸ */
        .list-area { width: 100%; max-width: 320px; margin-top: 15px; min-height: 100px; }
        .task-item { 
            background: white; padding: 8px 12px; border-radius: 8px; margin-bottom: 6px;
            font-size: 0.85rem; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03); border: 1px solid #eee;
        }
        .del-btn { color: #ccc; cursor: pointer; padding: 4px; }
        .del-btn:hover { color: red; }
        .empty-msg { text-align: center; color: #ccc; font-size: 0.8rem; margin-top: 20px; }
        
        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #FFD9E8; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <div class="header" id="month-year"></div>
        <div class="grid" id="calendar"></div>
    </div>

    <div class="list-area" id="list-area">
        <div class="loader" id="loader"></div>
    </div>

    <script>
        let eventsData = {}; // ë‚ ì§œë³„ ë°ì´í„° { "2025-11-30": ["í• ì¼1"] }
        let fullList = [];   // ì „ì²´ ë¦¬ìŠ¤íŠ¸ (ì‚­ì œìš© ID í¬í•¨)
        
        const calendarEl = document.getElementById('calendar');
        const listEl = document.getElementById('list-area');
        const loader = document.getElementById('loader');
        
        const date = new Date();
        const currentYear = date.getFullYear();
        const currentMonth = date.getMonth();

        // 1. íŒŒì´ì¬(API)í•œí…Œ ë°ì´í„° ë‹¬ë¼ê³  ìš”ì²­í•˜ê¸°
        async function fetchData() {
            try {
                const res = await fetch('/api/get_tasks'); // ì•„ê¹Œ ë§Œë“  íŒŒì´ì¬ ì£¼ì†Œ
                const data = await res.json();
                eventsData = data.events;
                fullList = data.list;
                
                loader.style.display = 'none'; // ë¡œë”© ë
                renderCalendar();
                showList(new Date().toISOString().split('T')[0]); // ì˜¤ëŠ˜ ë‚ ì§œ ë¦¬ìŠ¤íŠ¸ ë³´ì—¬ì£¼ê¸°
            } catch (err) {
                listEl.innerHTML = `<div class='empty-msg'>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ ã… <br>${err}</div>`;
            }
        }

        // 2. ë‹¬ë ¥ ê·¸ë¦¬ê¸°
        function renderCalendar() {
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();
            const monthNames = ["1ì›”", "2ì›”", "3ì›”", "4ì›”", "5ì›”", "6ì›”", "7ì›”", "8ì›”", "9ì›”", "10ì›”", "11ì›”", "12ì›”"];
            
            document.getElementById('month-year').innerText = `${currentYear}ë…„ ${monthNames[currentMonth]}`;
            calendarEl.innerHTML = `
                <div class="day-name">ì¼</div><div class="day-name">ì›”</div><div class="day-name">í™”</div>
                <div class="day-name">ìˆ˜</div><div class="day-name">ëª©</div><div class="day-name">ê¸ˆ</div><div class="day-name">í† </div>
            `;
            
            for(let i=0; i<firstDay; i++) calendarEl.innerHTML += `<div></div>`;
            
            for(let i=1; i<=lastDate; i++) {
                const dateKey = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const hasEvent = eventsData[dateKey];
                
                let dotHtml = '';
                if(hasEvent) {
                    const count = Math.min(hasEvent.length, 3);
                    dotHtml = `<div class="dot-box">${'<div class="dot"></div>'.repeat(count)}</div>`;
                }

                const todayClass = (i === new Date().getDate() && currentMonth === new Date().getMonth()) ? 'today' : '';
                const eventClass = hasEvent ? 'has-event' : '';
                
                const dayDiv = document.createElement('div');
                dayDiv.className = `day ${todayClass} ${eventClass}`;
                dayDiv.innerHTML = `<span>${i}</span>${dotHtml}`;
                dayDiv.onclick = () => showList(dateKey);
                
                calendarEl.appendChild(dayDiv);
            }
        }

        // 3. ë¦¬ìŠ¤íŠ¸ ë³´ì—¬ì£¼ê¸°
        function showList(dateKey) {
            const filtered = fullList.filter(item => item.date === dateKey);
            
            // ì„ íƒëœ ë‚ ì§œ í‘œì‹œ (ë””ìì¸ìƒ)
            const d = new Date(dateKey);
            const dateStr = `${d.getMonth()+1}ì›” ${d.getDate()}ì¼`;

            let html = `<div style="font-size:0.9rem; font-weight:bold; margin-bottom:10px; color:#555;">ğŸ“… ${dateStr}</div>`;
            
            if (filtered.length === 0) {
                html += `<div class="empty-msg">ì¼ì •ì´ ì—†ì–´ìš”!</div>`;
            } else {
                filtered.forEach(item => {
                    const check = item.completed ? "âœ…" : "â–«ï¸";
                    html += `
                        <div class="task-item">
                            <span>${check} ${item.task}</span>
                            <span class="del-btn" onclick="deleteTask('${item.id}')">âœ•</span>
                        </div>
                    `;
                });
            }
            listEl.innerHTML = html;
        }

        // 4. ì‚­ì œí•˜ê¸°
        async function deleteTask(pageId) {
            if(!confirm("ì§„ì§œ ì‚­ì œí• ê¹Œ?")) return;
            
            listEl.innerHTML = '<div class="loader"></div>'; // ë¡œë”© í‘œì‹œ
            
            await fetch('/api/delete_task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ page_id: pageId })
            });
            
            fetchData(); // ë‹¤ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ìƒˆë¡œê³ ì¹¨ íš¨ê³¼)
        }

        // ì‹œì‘!
        fetchData();
    </script>
</body>
</html>